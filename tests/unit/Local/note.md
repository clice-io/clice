## Scheduler 专项讨论

- 核心目标，负责调度和管理整个 Server 中 CPU heavy 的任务，防止出现类似 clangd 那样的服务器假死状态。

首先总共有哪些类 CPU heavy 的工作呢？
- 轻量级的预处理工作，如进行 module 依赖扫描或者 header context 的依赖图扫描
- 为给定的源文件构建 PCH，注意在之前的设想中，我曾希望 PCH 能在不同源文件中共享，只要它们具有相同的 preamble。实际上考虑到一些 corner case，这可能比较困难。主要是编译 PCH 的时候需要指定文件名，而不同主文件的文件名是不一样的，如果强行复用，这可能会导致诸如 `__FILE__` 和 `source_location` 这样依赖文件名的求值结果不一致。除此之外，如果 preamble 部分只有 `include` 这样的预处理指令，那确实可以进行复用。之后计划监听用户频繁编辑的文本区域，利用 Chained PCH 进一步扩大 preamble 的范围。
- 为模块构建依赖的 PCM，这个没什么难度，主要是需要递归的构建所有依赖的模块，并且要以一个比较高的并行度来进行。
- 基于前面构建的 PCM 和 PCH，为给定的文件构建 AST，实际上来说总体是比构建 PCH 和 PCM 要快的，当然这个也是视情况而定的。
- 基于前面的 PCH 和 PCM 运行代码补全和签名帮助
- 基于生成好的 AST，进行 Consume 的工作，响应各种 LSP 的请求，或者 Index，遍历 AST 线程不安全，一个 AST 上最多一个任务。
- 进行全量的后台索引更新，直接为一个文件构建 AST 并索引

上述所有的工作均有 Scheduler 负责，并暴露给外界接口进行获取。

以下是当用户打开或者更新一个文件的时候 Scheduler 进行的处理

- 打开或者更新一个文件，意味着我们要为这个文件构建 AST 了，那么如果这个文件有正在构建的 AST task，把它 cancel 掉。
- 上面这是 Update 的步骤，如果是 Open 的话可以跳过这一步。取消掉旧任务之后，就是开启一个新的构建 AST 的任务了。

- 具体如何开启一个新的构建任务？

首先构建任务有一个前置的任务依赖，那就是 PCH 构建，需要先检查 PCH 是否是最新的，如果是，然后再开启构建任务。这里其实就有一种依赖关系了