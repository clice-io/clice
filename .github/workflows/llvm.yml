name: llvm

on:
  push:
    branches: [main]
    paths:
      - ".github/workflows/llvm.yml"
      - "cmake/build-llvm.cmake"
      - "scripts/build-llvm.py"
      - "scripts/**"
      - "CMakeLists.txt"
      - "cmake/**"
      - "src/**"
      - "include/**"
      - "tests/**"

  pull_request:
    branches: [main]
    paths:
      - ".github/workflows/llvm.yml"
      - "cmake/build-llvm.cmake"
      - "scripts/build-llvm.py"
      - "scripts/**"
      - "CMakeLists.txt"
      - "cmake/**"
      - "src/**"
      - "include/**"
      - "tests/**"

jobs:
  build:
    env:
      CCACHE_BASEDIR: ${{ github.workspace }}
      CCACHE_COMPILERCHECK: content
      CCACHE_NOHASHDIR: 1
      CCACHE_MAXSIZE: 8G
    strategy:
      fail-fast: false
      matrix:
        include:
          # Windows
          - os: windows-2025
            llvm_mode: Debug
            lto: OFF
          - os: windows-2025
            llvm_mode: RelWithDebInfo
            lto: OFF
          - os: windows-2025
            llvm_mode: RelWithDebInfo
            lto: ON
          # Linux
          - os: ubuntu-24.04
            llvm_mode: Debug
            lto: OFF
          - os: ubuntu-24.04
            llvm_mode: RelWithDebInfo
            lto: OFF
          - os: ubuntu-24.04
            llvm_mode: RelWithDebInfo
            lto: ON
          # macOS
          - os: macos-15
            llvm_mode: Debug
            lto: OFF
          - os: macos-15
            llvm_mode: RelWithDebInfo
            lto: OFF
          - os: macos-15
            llvm_mode: RelWithDebInfo
            lto: ON

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: ccache-${{ matrix.os }}-${{ matrix.llvm_mode }}-${{ matrix.lto }}-${{ hashFiles('CMakeLists.txt', 'cmake/**/*.cmake', 'scripts/build-llvm.py', 'xmake.lua') }}
          restore-keys: |
            ccache-${{ matrix.os }}-${{ matrix.llvm_mode }}-${{ matrix.lto }}-
            ccache-${{ matrix.os }}-
          max-size: 8G

      - name: Start resource monitor (Linux/macOS)
        if: runner.os != 'Windows'
        run: |
          MONITOR_LOG="${RUNNER_TEMP}/resource-usage.log"
          bash scripts/monitor-resources.sh "${MONITOR_LOG}" >/dev/null 2>&1 &
          echo "RESOURCE_MONITOR_PID=$!" >> "${GITHUB_ENV}"
          echo "RESOURCE_MONITOR_LOG=${MONITOR_LOG}" >> "${GITHUB_ENV}"

      - name: Start resource monitor (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $log = Join-Path $Env:RUNNER_TEMP "resource-usage.log"
          $script = Join-Path $PWD.Path "scripts/monitor-resources.ps1"
          $job = Start-Job -FilePath $script -ArgumentList $log, 30
          "RESOURCE_MONITOR_JOB_ID=$($job.Id)" | Out-File -FilePath $Env:GITHUB_ENV -Append
          "RESOURCE_MONITOR_LOG=$log" | Out-File -FilePath $Env:GITHUB_ENV -Append

      - name: Free Disk Space
        if: runner.os == 'Linux'
        uses: jlumbroso/free-disk-space@main

      - name: Increase Swap Space
        if: runner.os == 'Linux'
        run: |
          echo "===== Initial Status ====="
          sudo swapon --show
          free -h

          echo "===== Creating Swap File ====="
          sudo swapoff -a
          sudo fallocate -l 16G /mnt/swapfile
          sudo chmod 600 /mnt/swapfile
          sudo mkswap /mnt/swapfile
          sudo swapon /mnt/swapfile

          echo "===== Final Status ====="
          sudo swapon --show
          free -h
          df -h

      - name: Setup Pixi
        uses: prefix-dev/setup-pixi@v0.9.3
        with:
          pixi-version: v0.59.0
          environments: develop
          activate-environment: true
          cache: true
          locked: true

      - name: Clone llvm-project (21.1.4)
        shell: bash
        run: |
          git clone --branch llvmorg-21.1.4 --depth 1 https://github.com/llvm/llvm-project.git .llvm

      - name: Build LLVM (install-distribution)
        shell: bash
        env:
          CCACHE_PROGRAM: ccache
          CLICE_USE_CCACHE: 1
        run: |
          pixi run build-llvm --llvm-src=.llvm --mode="${{ matrix.llvm_mode }}" --lto="${{ matrix.lto }}" --build-dir=build

      - name: Build clice using installed LLVM
        shell: bash
        run: |
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=${{ matrix.llvm_mode }} \
            -DCMAKE_TOOLCHAIN_FILE=cmake/toolchain.cmake \
            -DCLICE_ENABLE_TEST=ON \
            -DCLICE_CI_ENVIRONMENT=ON \
            -DCMAKE_C_COMPILER_LAUNCHER=ccache \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
            -DCLICE_ENABLE_LTO=${{ matrix.lto }} \
            -DLLVM_INSTALL_PATH=".llvm/build-install"
          cmake --build build

      - name: Run tests
        shell: bash
        run: |
          EXE_EXT=""
          if [[ "${{ runner.os }}" == "Windows" ]]; then
            EXE_EXT=".exe"
          fi
          ./build/bin/unit_tests${EXE_EXT} --test-dir="./tests/data"
          uv run --project tests pytest -s --log-cli-level=INFO tests/integration --executable=./build/bin/clice${EXE_EXT}

      - name: Prune LLVM static libraries (Debug/RelWithDebInfo no LTO)
        if: matrix.llvm_mode == 'Debug' || (matrix.llvm_mode == 'RelWithDebInfo' && matrix.lto == 'OFF')
        shell: bash
        run: |
          MANIFEST="pruned-libs-${{ matrix.os }}.json"
          echo "LLVM_PRUNED_MANIFEST=${MANIFEST}" >> "${GITHUB_ENV}"
          python3 scripts/prune-llvm-bin.py \
            --action discover \
            --bin-dir ".llvm/build-install/lib" \
            --build-dir "build" \
            --max-attempts 60 \
            --sleep-seconds 60 \
            --manifest "${MANIFEST}"

      - name: Upload pruned-libs manifest
        if: matrix.llvm_mode == 'RelWithDebInfo' && matrix.lto == 'OFF'
        uses: actions/upload-artifact@v4
        with:
          name: llvm-pruned-libs-${{ matrix.os }}
          path: ${{ env.LLVM_PRUNED_MANIFEST }}
          if-no-files-found: error

      - name: Apply pruned-libs manifest (RelWithDebInfo + LTO)
        if: matrix.llvm_mode == 'RelWithDebInfo' && matrix.lto == 'ON'
        shell: bash
        run: |
          MANIFEST="pruned-libs-${{ matrix.os }}.json"
          python3 scripts/prune-llvm-bin.py \
            --action apply \
            --manifest "${MANIFEST}" \
            --bin-dir ".llvm/build-install/lib" \
            --build-dir "build" \
            --gh-run-id "${{ github.run_id }}" \
            --gh-artifact "llvm-pruned-libs-${{ matrix.os }}" \
            --gh-download-dir "artifacts" \
            --max-attempts 60 \
            --sleep-seconds 60

      - name: Package LLVM install directory
        shell: bash
        run: |
          MODE_TAG="releasedbg"
          if [[ "${{ matrix.llvm_mode }}" == "Debug" ]]; then
            MODE_TAG="debug"
          fi
          LTO_TAG="off"
          if [[ "${{ matrix.lto }}" == "ON" ]]; then
            LTO_TAG="on"
          fi

          case "${{ matrix.os }}" in
            windows-*) ARCHIVE="llvm-${MODE_TAG}-win-x64-msvc-lto-${LTO_TAG}.tar.gz" ;;
            ubuntu-*)  ARCHIVE="llvm-${MODE_TAG}-linux-x64-gnu-lto-${LTO_TAG}.tar.gz" ;;
            macos-*)   ARCHIVE="llvm-${MODE_TAG}-macos-arm64-clang-lto-${LTO_TAG}.tar.gz" ;;
            *)         ARCHIVE="llvm-${MODE_TAG}-${{ matrix.os }}-lto-${LTO_TAG}.tar.gz" ;;
          esac

          python scripts/package_llvm_install.py --install-dir .llvm/build-install --output "${ARCHIVE}" --compresslevel 6
          echo "LLVM_INSTALL_ARCHIVE=${ARCHIVE}" >> "${GITHUB_ENV}"

      - name: Upload LLVM install artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.LLVM_INSTALL_ARCHIVE }}
          path: ${{ env.LLVM_INSTALL_ARCHIVE }}
          if-no-files-found: error

      - name: Dump resource monitor log (Linux/macOS)
        if: always() && runner.os != 'Windows'
        shell: bash
        run: |
          echo "===== Resource usage log ====="
          if [[ -n "${RESOURCE_MONITOR_LOG:-}" && -f "${RESOURCE_MONITOR_LOG}" ]]; then
            cat "${RESOURCE_MONITOR_LOG}"
          else
            echo "Resource log not found"
          fi

      - name: Dump resource monitor log (Windows)
        if: always() && runner.os == 'Windows'
        shell: pwsh
        run: |
          Write-Host "===== Resource usage log ====="
          if ($Env:RESOURCE_MONITOR_LOG -and (Test-Path $Env:RESOURCE_MONITOR_LOG)) {
            Get-Content $Env:RESOURCE_MONITOR_LOG
          } else {
            Write-Host "Resource log not found"
          }
